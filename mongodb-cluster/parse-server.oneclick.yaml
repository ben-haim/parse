apiVersion: v1
kind: ConfigMap
metadata:
  name: parse-server-config
  namespace: default
data:
  databaseURI: "mongodb://mongodb-service-master,mongodb-service-replica-1,mongodb-service-replica-2:27017/db?replicaSet=rs0"
  appId: "parse-app-id"
  masterKey: parse-app-master-key@k8s
  mountPath: /
  port: "1337"

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: parse-server
spec:
  selector:
    matchLabels:
      app: parse-server
  template:
    metadata:
      labels:
        app: parse-server
    spec:
      containers:
      - name: parse-server
        image: parseplatform/parse-server
        ports:
        - containerPort: 1337
        env:
          - name: PARSE_SERVER_APPLICATION_ID
            valueFrom:
              configMapKeyRef:
                name: parse-server-config
                key: appId
          - name: PARSE_SERVER_DATABASE_URI
            valueFrom:
              configMapKeyRef:
                name: parse-server-config
                key: databaseURI
          - name: PARSE_SERVER_MOUNT_PATH
            valueFrom:
              configMapKeyRef:
                name: parse-server-config
                key: mountPath              
          - name: PARSE_SERVER_MASTER_KEY
            valueFrom:
                configMapKeyRef:
                  name: parse-server-config
                  key: masterKey

---

kind: Service
apiVersion: v1
metadata:
  name: parse-server
  labels:
    name: parse-server
spec:
  selector:
    app: parse-server
  ports:
  - port: 1337
    targetPort: 1337
    protocol: TCP
  type: NodePort
